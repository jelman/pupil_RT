---
title: "Pupillometry and Simple Reaction Time"
author: "Jeremy Elman"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

Load libraries
```{r results='hide', message=FALSE, warning=FALSE}
library(ggplot2)
library(gridExtra)
library(gtools)
library(lme4)
library(arm)
library(lmerTest)
library(dplyr)
library(magrittr)
library(sjPlot)
library(sjmisc)
library(multcomp)
source("K:/code/summarySE.R")
source("K:/code/normDataWithin.R")
source("K:/code/summarySEwithin.R")
source("K:/code/get_legend.R")
```

Load data.
```{r}
pupilSimpleRT = read.csv("K:/ReactionTime/data/pupil_simpleRT.csv", 
                         stringsAsFactors = FALSE)
pupilSimpleRT = pupilSimpleRT[!is.na(pupilSimpleRT$PCA),]
pupilSimpleRT = subset(pupilSimpleRT, vetsa2=='vetsa2')
str(pupilSimpleRT)
```

Recode two-level factors to 0/1. Center continuous data.
*TRANSFORM*
```{r}
# Create factors
pupilSimpleRT$facLoad = factor(pupilSimpleRT$Load)
contr.backward.diff = matrix(c(-2/3, 1/3, 1/3,-1/3,-1/3,2/3), ncol = 2)
contrasts(pupilSimpleRT$facLoad) = contr.backward.diff
pupilSimpleRT$MZ = ifelse(pupilSimpleRT$zyg14==1, 1, 0)
pupilSimpleRT$site_v2rev = ifelse(pupilSimpleRT$site_v2rev==1, 1, 0)
pupilSimpleRT$Device = factor(pupilSimpleRT$LR_Device)
pupilSimpleRT$acamedbin = ifelse(pupilSimpleRT$acamedtot==0, 0, 1)

#Bin MCI data into 0 = No impairment, 1 = Single domain MCI, 2 = Multi-domain MCI.
pupilSimpleRT$rMCI_cons_bin = ifelse(pupilSimpleRT$rMCI_cons_v2==0, 0, 
                                        ifelse(pupilSimpleRT$rMCI_cons_v2==1 | 
                                               pupilSimpleRT$rMCI_cons_v2==2, 1, 2))

# Center continuous variables to interpret intercept at mean value (rather than 0).
# Subject specific variables centered at subject level, trial specific variables centered at trial level.
contTrialVars = c("PCA","pctPCA","adjPCA")
contSubjVars = c("age_v2","afqtpcttran_v2","DSFMAX_v2")

# Center trial specific variables
for (x in contTrialVars) {
  newcol = paste0('c.',x)
  pupilSimpleRT[[newcol]] = as.numeric(scale(pupilSimpleRT[[x]], center=TRUE, scale=FALSE))
}

# Center subject specific variables
subjDF = pupilSimpleRT[c("vetsaid",contSubjVars)]
subjDF %<>% group_by(vetsaid) %>% dplyr::summarise_each(funs(first))
nums <- sapply(subjDF, is.numeric)
c.subjDF = as.data.frame(apply(subjDF[,nums],2, function(y) y - mean(y, na.rm=TRUE)))
names(c.subjDF) = paste0("c.",names(c.subjDF))
c.subjDF$vetsaid = subjDF$vetsaid
pupilSimpleRT = left_join(pupilSimpleRT, c.subjDF, by="vetsaid")

# Create quantile groups of log RT data
pupilSimpleRT %<>%
  group_by(vetsaid) %>%
  dplyr::summarise(log_meanRT = mean(log_meanRT),
                   log_medianRT = mean(log_medianRT),
                   log_stdRT = mean(log_stdRT),
                   resid_log_stdRT = mean(resid_log_stdRT),
                   log_cvRT = mean(log_cvRT)) %>%
  mutate(q.log_meanRT = quantcut(log_meanRT, q=4, labels=seq(1,4)),
         q.log_medianRT = quantcut(log_medianRT, q=4, labels=seq(1,4)),
         q.log_stdRT = quantcut(log_stdRT, q=4, labels=seq(1,4)),
         q.resid_log_stdRT = quantcut(resid_log_stdRT, q=4, labels=seq(1,4)),
         q.log_cvRT = quantcut(log_cvRT, q=4, labels=seq(1,4))) %>%
  dplyr::select(vetsaid,q.log_meanRT,q.log_medianRT,q.log_stdRT,
                q.resid_log_stdRT,q.log_cvRT) %>%
  inner_join(pupilSimpleRT, by="vetsaid")

# Create residPCA by regressing BaselineDiameter from PCA and taking the residuals.
lme.PCA.resid = lmer(PCA ~ BaselineDiameter + (1 | case/vetsaid),
                     data=pupilSimpleRT)
pupilSimpleRT$residPCA = resid(lme.PCA.resid)
```

# Basic sample descriptives
```{r, include=FALSE}
#Create dataset with subject level variables to assess relationships with BOLD variance.

subjDatSimpleRT = pupilSimpleRT %>% 
            dplyr::select(-contains("PCA"),-contains("Load")) %>%
            group_by(vetsaid) %>%
            summarise_each(funs(first))
```

How many subjects?
```{r}
n_distinct(subjDatSimpleRT$vetsaid)
```

How many attrition replacements?
```{r}
dplyr::count(subjDatSimpleRT, vetsa2)
```

How many twin pairs vs unpaired twins? 
```{r}
subjDatSimpleRT %>%
  group_by(case) %>%
  dplyr::summarise(n_twins = n_distinct(vetsaid)) %>%
  dplyr::count(n_twins)
```


How many MZ and DZ pairs? (excludes unpaired subjects)
```{r}
subjDatSimpleRT %>% 
  group_by(case) %>%
  mutate(n_twins = n_distinct(vetsaid)) %>%
  filter(n_twins > 1) %>%
  dplyr::summarise(zyg = mean(zyg14)) %>%
  group_by(zyg) %>%
  dplyr::count(zyg)
```

How many levels of load did subjects complete? Shows number of subjects who completed 1, 2, or 3 levels (corresponding to digit spans of 3, 6, and 9).
```{r}
pupilSimpleRT %>%
  group_by(vetsaid) %>%
  dplyr::summarise(load = n()) %>%
  dplyr::count(load)
```

How many of each MCI group?
```{r}
dplyr::count(subjDatSimpleRT, rMCI_cons_v2)
```


Plot pctPCA and residPCA data to check for ceiling effects on pupil dilation
```{r}
pctPcaPlot = ggplot(pupilSimpleRT, aes(x=pctPCA)) + 
  geom_histogram(fill="steel blue",color="gray50",alpha=.7) + 
  facet_wrap(~ Load, nrow=3) + 
  ggtitle("Histogram of pctPCA by Load") + 
  xlab("% PCA") + theme_bw() 

residPcaPlot = ggplot(pupilSimpleRT, aes(x=residPCA)) + 
  geom_histogram(fill="steel blue",color="gray50",alpha=.7) + 
  facet_wrap(~ Load, nrow=3) + 
  ggtitle("Histogram of residPCA by Load") + 
  xlab("PCA (adjusted for baseline)") + theme_bw() 

grid.arrange(pctPcaPlot, residPcaPlot, ncol=2)
```


```{r, include=FALSE}
pdf("K:/ReactionTime/results/PCAxLoad.pdf")
grid.arrange(pctPcaPlot, residPcaPlot, ncol=2)
dev.off()
```

Plot histograms of RT measures
```{r}
rtSubset = pupilSimpleRT %>%
  filter(Load==3) %>%
  dplyr::select(log_meanRT, log_medianRT, 
                log_stdRT, resid_log_stdRT, log_cvRT)

plot_list = list()
for (i in 1:ncol(rtSubset)) {
  p = ggplot(rtSubset,aes_string(x = rtSubset[i])) +
        geom_histogram(fill="steelblue",color="gray50",alpha=.7) + 
        xlab(names(rtSubset[i])) + theme_bw()
  plot_list[[i]] = p
}


do.call(grid.arrange, c(plot_list, list(ncol=2)))
```

```{r, include=FALSE}
pdf("K:/ReactionTime/results/rtHists.pdf")
do.call(grid.arrange, c(plot_list, list(ncol=2)))
dev.off()
```

Plot pupil dilation of all RT measure quantile groups
```{r}
rtMeasures = c("log_meanRT","log_medianRT",
               "log_stdRT","resid_log_stdRT","log_cvRT")
measureList = list()
for (measure in rtMeasures){
  measureList[[measure]] = summarySEwithin(pupilSimpleRT, 
                measurevar="residPCA", 
                idvar="vetsaid", 
                withinvars="Load", 
                betweenvars=paste0("q.",measure),
                na.rm=TRUE)
}

q.rtMeasures = paste("q",rtMeasures, sep=".")
plot_list = list()
for (i in 1:length(q.rtMeasures)) {
  p = ggplot(measureList[[i]], aes_string(x="Load",y="residPCA", 
                              color=q.rtMeasures[i], group=q.rtMeasures[i])) +
    geom_line() + 
    geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
    ggtitle(paste0("Pupil dilation by ",q.rtMeasures[i]," quantile")) +
    theme_bw(14) + ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
    scale_color_discrete(name="quantile")
  plot_list[[i]] = p
}

legend = get_legend(plot_list[[1]])
for (i in 1:length(plot_list)) {
  plot_list[[i]] = plot_list[[i]] + theme(legend.position="none")
}
plot_list$legend = legend

#Save out plot
pdf("K:/ReactionTime/results/PCAxLoadxSimpleRT_allGroups.pdf",width=12,height=10)
do.call(grid.arrange,  c(plot_list, list(ncol=2)))
dev.off()
```


```{r, include=FALSE}
#Plot pupil dilation of upper and lower RT measure quantile groups
plot_list = list()
for (i in 1:length(q.rtMeasures)) {
  call <- substitute(filter(summarydf, target==1 | target==4),
                         list(summarydf = measureList[[i]],
                              target = as.name(q.rtMeasures[[i]]))) 
  df = eval(call) 
  p = ggplot(df, aes_string(x="Load",y="residPCA", 
                              color=q.rtMeasures[i], group=q.rtMeasures[i])) +
    geom_line() + 
    geom_errorbar(width=.1, aes(ymin=residPCA-ci,ymax=residPCA+ci)) +
    ggtitle(paste0("Pupil dilation by ",q.rtMeasures[i]," quantile")) +
    theme_bw(14) + ylab("Change in Pupil Diameter\n(Adjusted for Baseline)") +
    scale_color_discrete(name=paste0(rtMeasures[i],"\nquantile"),
                         labels=c("Lower","Upper"))
  plot_list[[i]] = p
}

legend = get_legend(plot_list[[1]])
for (i in 1:length(plot_list)) {
  plot_list[[i]] = plot_list[[i]] + theme(legend.position="none")
}
plot_list$legend = legend

# Save out plot
pdf("K:/ReactionTime/results/PCAxLoadxSimpleRT_Quartiles.pdf",width=12,height=10)
do.call(grid.arrange,  c(plot_list, list(ncol=2)))
dev.off()
```


```{r, include=FALSE}
# Levels of load to test
loads = c(3,6,9)
```

**Log Mean RT**
```{r, echo=FALSE}
plot_list[[1]]
```

Run basic model testing interaction of Load with log mean RT
```{r}
contrasts.facLoad.log_meanRT = rbind(
    'Load3:log_meanRT vs Load6:log_meanRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
    'Load6:log_meanRT vs Load9:log_meanRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1),
    'Load3:log_meanRT vs Load9:log_meanRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
)
lme.facLoad.log_meanRT = lmer(residPCA ~ facLoad*log_meanRT + apoe4 + c.age_v2 + 
                            site_v2rev + Device + acamedbin + c.DSFMAX_v2 +
                            c.afqtpcttran_v2 + (1 | case/vetsaid), 
                          data=pupilSimpleRT)
summary(lme.facLoad.log_meanRT)
summary(glht(lme.facLoad.log_meanRT, contrasts.facLoad.log_meanRT), 
              test = adjusted("none"))
```

Test for differences based on mean RT within each level of Load
```{r}
lme.log_meanRT.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log_meanRT + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), data=filter(pupilSimpleRT,Load==x))
})
lapply(lme.log_meanRT.loads, summary)
```

**Log Median RT**
```{r, echo=FALSE}
plot_list[[2]]
```

Run basic model testing interaction of Load with log median RT
```{r}
contrasts.facLoad.log_medianRT = rbind(
    'Load3:log_medianRT vs Load6:log_medianRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
    'Load6:log_medianRT vs Load9:log_medianRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1),
    'Load3:log_medianRT vs Load9:log_medianRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
)
lme.facLoad.log_medianRT = lmer(residPCA ~ facLoad*log_medianRT + apoe4 + 
                                  c.age_v2 + site_v2rev + Device + acamedbin +
                                  c.DSFMAX_v2 + c.afqtpcttran_v2 +
                                  (1 | case/vetsaid), data=pupilSimpleRT)
summary(lme.facLoad.log_medianRT)
summary(glht(lme.facLoad.log_medianRT, contrasts.facLoad.log_medianRT), 
              test = adjusted("none"))
```

Test for differences based on median RT within each level of Load
```{r}
lme.log_medianRT.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log_medianRT + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), data=filter(pupilSimpleRT,Load==x))
})
lapply(lme.log_medianRT.loads, summary)
```

**Log Standard Deviation RT**
```{r, echo=FALSE}
plot_list[[3]]
```

Run basic model testing interaction of Load with log standard deviation RT
```{r}
contrasts.facLoad.log_stdRT = rbind(
    'Load3:log_stdRT vs Load6:log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
    'Load6:log_stdRT vs Load9:log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1),
    'Load3:log_stdRT vs Load9:log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
)
lme.facLoad.log_stdRT = lmer(residPCA ~ facLoad*log_stdRT + apoe4 + c.age_v2 + 
                            site_v2rev + Device + acamedbin + c.DSFMAX_v2 +
                            c.afqtpcttran_v2 + (1 | case/vetsaid), 
                          data=pupilSimpleRT)
summary(lme.facLoad.log_stdRT)
summary(glht(lme.facLoad.log_stdRT, contrasts.facLoad.log_stdRT), 
              test = adjusted("none"))
```

Test for differences based on standard deviation RT within each level of Load
```{r}
lme.log_stdRT.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log_stdRT + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), data=filter(pupilSimpleRT,Load==x))
})
lapply(lme.log_stdRT.loads, summary)
```

**Log Residual Standard Deviation RT**
```{r, echo=FALSE}
plot_list[[4]]
```

Run basic model testing interaction of Load with residual log standard deviation RT
```{r}
contrasts.facLoad.resid_log_stdRT = rbind(
    'Load3:resid_log_stdRT vs Load6:resid_log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
    'Load6:resid_log_stdRT vs Load9:resid_log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1),
    'Load3:resid_log_stdRT vs Load9:resid_log_stdRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
)
lme.facLoad.resid_log_stdRT = lmer(residPCA ~ facLoad*resid_log_stdRT + 
                                   apoe4 + c.age_v2 + site_v2rev + Device +
                                   acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 +
                                   (1 | case/vetsaid),
                                   data=pupilSimpleRT)
summary(lme.facLoad.resid_log_stdRT)
summary(glht(lme.facLoad.resid_log_stdRT, contrasts.facLoad.resid_log_stdRT), 
              test = adjusted("none"))
```

Test for differences based on residual standard deviation RT within each level of Load
```{r}
lme.resid_log_stdRT.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ resid_log_stdRT + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), data=filter(pupilSimpleRT,Load==x))
})
lapply(lme.resid_log_stdRT.loads, summary)
```

**Log Coefficient of Variation RT**
```{r, echo=FALSE}
plot_list[[5]]
```

Run basic model testing interaction of Load with log coeffient of variance RT
```{r}
contrasts.facLoad.log_cvRT = rbind(
    'Load3:log_cvRT vs Load6:log_cvRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
    'Load6:log_cvRT vs Load9:log_cvRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,-1,1),
    'Load3:log_cvRT vs Load9:log_cvRT' = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
)
lme.facLoad.log_cvRT = lmer(residPCA ~ facLoad*log_cvRT + apoe4 + c.age_v2 + 
                            site_v2rev + Device + acamedbin + c.DSFMAX_v2 +
                            c.afqtpcttran_v2 + (1 | case/vetsaid), 
                          data=pupilSimpleRT)
summary(lme.facLoad.log_cvRT)
summary(glht(lme.facLoad.log_cvRT, contrasts.facLoad.log_cvRT), 
              test = adjusted("none"))
```

Test for differences based on coeffiecient of variation RT within each level of Load
```{r}
lme.log_cvRT.loads <- lapply(loads, function(x) {
    lmer(residPCA ~ log_cvRT + apoe4 + c.age_v2 + site_v2rev + 
                    Device + acamedbin + c.DSFMAX_v2 + c.afqtpcttran_v2 + 
                    (1 | case), data=filter(pupilSimpleRT,Load==x))
})
lapply(lme.log_cvRT.loads, summary)
```

----------------------------
Save out analysis dataset
```{r, include=FALSE}
write.csv(pupilSimpleRT, "K:/ReactionTime/data/pupilDS_SimpleRT_AnalysisDataset.csv")
```

```{r}
print(sessionInfo(), locale = FALSE)
```